# OurMemory 内测管理操作指南

## 一、管理员权限配置

### 1.1 添加sudo用户
```bash
# 1. 进入云开发控制台
# 2. 选择数据库
# 3. 进入app_config集合
# 4. 查找key为"sudo_users"的文档
# 5. 在value数组中添加新的管理员openid
```

### 1.2 验证sudo权限
```javascript
// 通过云函数验证
// cloudfunctions/user_center/utils/config.js:22
// 系统会自动从数据库读取sudo_users列表
```

## 二、兑换码管理

### 2.1 生成兑换码
```bash
# 进入项目根目录
cd /path/to/OurMemory

# 批量生成10个默认配置的兑换码
node scripts/add_vip_codes.js

# 生成指定数量的兑换码
node scripts/add_vip_codes.js --count 50

# 生成特定配置的兑换码
node scripts/add_vip_codes.js --days 30 --quota 10 --limit 50

# 生成指定内容的兑换码
node scripts/add_vip_codes.js --code "WELCOME2024" --days 7 --quota 3
```

### 2.2 兑换码参数说明
| 参数 | 说明 | 默认值 | 示例 |
|-----|------|--------|------|
| --count | 生成数量 | 10 | --count 20 |
| --days | VIP天数 | 10 | --days 30 |
| --quota | 永久额外次数 | 5 | --quota 10 |
| --limit | 使用次数限制 | 100 | --limit 50 |
| --prefix | 兑换码前缀 | "LOVE-" | --prefix "VIP-" |
| --code | 指定兑换码内容 | 随机生成 | --code "NEWYEAR2024" |

### 2.3 查看兑换码使用情况
```javascript
// 在云开发控制台执行
db.collection('vip_codes').where({
  code: 'LOVE-XXXXX'
}).get()

// 查看所有兑换码使用统计
db.collection('vip_codes').field({
  code: true,
  usedCount: true,
  usageLimit: true,
  isActive: true
}).get()
```

### 2.4 禁用/启用兑换码
```javascript
// 禁用兑换码
db.collection('vip_codes').doc('document_id').update({
  isActive: false
})

// 启用兑换码
db.collection('vip_codes').doc('document_id').update({
  isActive: true
})
```

## 三、用户管理

### 3.1 给用户授权VIP
```javascript
// 通过云函数user_center调用grantVip接口
// 需要sudo权限

// 请求示例
{
  "action": "grantVip",
  "targetOpenid": "用户openid",
  "days": 30,
  "extraQuota": 10
}
```

### 3.2 查看用户VIP状态
```javascript
// 在云开发控制台查询
db.collection('users').where({
  _id: '用户openid'
}).field({
  vipExpireTime: true,
  permanentFilmQuota: true,
  trialVipStartTime: true,
  registerTime: true
}).get()
```

### 3.3 手动调整用户数据
```javascript
// 增加永久次数
db.collection('users').doc('user_openid').update({
  permanentFilmQuota: _.inc(10)  // 增加10次
})

// 延长VIP时间
db.collection('users').doc('user_openid').update({
  vipExpireTime: new Date('2024-12-31')
})
```

## 四、系统配置管理

### 4.1 调整业务规则
```json
// 编辑 miniprogram/utils/business_rules.json
{
  "NORMAL_FREE_LIMIT": 2,        // 调整普通用户每日次数
  "VIP_DAILY_LIMIT": 10,         // 调整VIP用户每日次数
  "REG_DAY_LIMIT": 20,           // 调整注册日奖励
  "VIP_TRIAL_DAYS": 7            // 统一试用天数为7天
}
```

### 4.2 控制功能开关
```javascript
// 关闭VIP兑换功能
db.collection('app_config').where({
  key: 'vip_exchange_enabled'
}).update({
  value: false
})

// 开启VIP兑换功能
db.collection('app_config').where({
  key: 'vip_exchange_enabled'
}).update({
  value: true
})
```

### 4.3 配置测试白名单
```javascript
// 编辑 cloudfunctions/process_anime/index.js
const TEST_CONFIG = {
  WHITELIST: [
    'test_openid_1',
    'test_openid_2'
  ],
  ENABLE: true,  // 生产环境设为false
};
```

## 五、数据统计与分析

### 5.1 统计VIP用户数
```javascript
// 查询当前有效VIP用户
db.collection('users').where({
  vipExpireTime: _.gt(new Date())
}).count()

// 查询试用VIP用户
db.collection('users').where({
  trialVipStartTime: _.exists(true),
  vipExpireTime: _.gt(new Date())
}).count()
```

### 5.2 统计兑换码使用情况
```javascript
// 总兑换次数
db.collection('vip_codes').aggregate()
  .group({
    _id: null,
    totalUsed: _.sum('$usedCount')
  })
  .end()

// 最受欢迎的兑换码
db.collection('vip_codes').orderBy('usedCount', 'desc').limit(10).get()
```

### 5.3 统计用户增长
```javascript
// 每日新增用户
db.collection('users').aggregate()
  .group({
    _id: _.dateToString({
      date: '$registerTime',
      format: '%Y-%m-%d'
    }),
    count: _.sum(1)
  })
  .sort({
    _id: -1
  })
  .end()
```

## 六、运营活动配置

### 6.1 节日活动兑换码
```bash
# 生成新年活动兑换码
node scripts/add_vip_codes.js --prefix "NY2024-" --count 1000 --days 15 --quota 20

# 生成情人节活动兑换码
node scripts/add_vip_codes.js --prefix "LOVE2024-" --count 500 --days 7 --quota 7
```

### 6.2 邀请奖励调整
```javascript
// 修改邀请奖励天数（在代码中）
// cloudfunctions/user_center/services/auth.js:107
// 将1天改为3天
await db.collection('users').doc(userRecord._id).update({
  vipExpireTime: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000),
  trialVipStartTime: new Date(),
});
```

## 七、常见问题处理

### 7.1 用户反馈没有收到VIP
```javascript
// 检查步骤
1. 查询用户记录
2. 检查vipExpireTime字段
3. 检查trialVipStartTime字段
4. 查看inviterOpenid（是否通过邀请注册）
5. 查看bindPartnerOpenid（是否绑定伴侣）
```

### 7.2 兑换码无法使用
```javascript
// 排查清单
1. 兑换码格式是否正确
2. 兑换码是否存在
3. isActive是否为true
4. usedCount是否小于usageLimit
5. expireTime是否未过期
```

### 7.3 次数计算异常
```javascript
// 检查逻辑
1. lastFreeResetTime是否正确
2. 当日是否已重置
3. 永久次数是否正确扣减
4. VIP状态是否正确判断
```

## 八、安全操作规范

### 8.1 管理员操作注意事项
1. **确认操作对象**：修改前务必确认用户openid
2. **记录操作日志**：重要操作需要手动记录
3. **备份数据**：批量操作前先备份相关数据
4. **测试环境验证**：先在测试环境验证操作

### 8.2 兑换码管理安全
1. **保密原则**：兑换码在发放前保持机密
2. **使用追踪**：定期检查异常使用情况
3. **过期管理**：及时清理过期的兑换码
4. **限量发行**：控制每批兑换码的数量

## 九、应急处理方案

### 9.1 系统异常处理
```javascript
// 1. 关闭测试模式
// 修改TEST_CONFIG.ENABLE = false

// 2. 临时禁用兑换功能
// 设置vip_exchange_enabled = false

// 3. 扩展用户VIP
// 批量更新受影响用户
```

### 9.2 数据恢复
```javascript
// 从备份恢复数据
// 使用云开发提供的备份恢复功能
// 确保恢复时间点选择正确
```

## 十、定期维护任务

### 10.1 每日检查
- 兑换码使用情况监控
- 异常用户行为检测
- 系统错误日志查看

### 10.2 每周任务
- 清理过期兑换码
- 统计VIP用户增长
- 分析用户使用数据

### 10.3 每月任务
- 生成运营数据报告
- 评估VIP权益效果
- 调整业务规则参数

## 附录：常用数据库查询语句

```javascript
// 1. 查询所有VIP用户
db.collection('users').where({
  vipExpireTime: _.gt(new Date())
}).get()

// 2. 查询即将过期的VIP用户
db.collection('users').where({
  vipExpireTime: _.gt(new Date()),
  vipExpireTime: _.lt(new Date(Date.now() + 7 * 24 * 60 * 60 * 1000))
}).get()

// 3. 查询永久次数最多的用户
db.collection('users').orderBy('permanentFilmQuota', 'desc').limit(10).get()

// 4. 查询今日注册用户
db.collection('users').where({
  registerTime: _.gte(new Date(new Date().setHours(0, 0, 0, 0)))
}).get()
```