# OurMemory 内测系统架构图 (已归档)

> **注意**：本文档已归档，仅作为历史参考。请查看最新的VIP系统部署指南。

## 系统整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                     OurMemory 内测系统                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐    ┌──────────────┐    ┌──────────────┐   │
│  │   前端UI     │◄──►│  云函数层     │◄──►│   数据库层    │   │
│  │             │    │              │    │              │   │
│  │ 我的页面     │    │ user_center  │    │   users      │   │
│  │ VIP展示     │    │              │    │   vip_codes  │   │
│  │ 兑换码输入   │    │ process_anime│    │  app_config  │   │
│  │ 权益说明     │    │              │    │              │   │
│  └─────────────┘    └──────────────┘    └──────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## VIP权限体系架构

```
                    VIP权限体系
                         │
      ┌──────────────────┼──────────────────┐
      │                  │                  │
  永久VIP(isPermanentVip)  试用VIP(isTrialVip)  普通用户
      │                  │                  │
      ├─ 管理员权限        ├─ 时长限制          ├─ 基础权限
      ├─ 无限次数          ├─ 7天/3天          ├─ 每日1次
      ├─ 可授权他人        ├─ 每日7次          └─ 可通过邀请获得
      └─ 特殊标识          └─ 可延长期限
```

## 核心业务流程图

### 1. 用户注册流程
```
用户注册
    │
    ├─ 是否有邀请者？ ──是──► 更新邀请者信息
    │        │                     │
    │       否                      │
    │        │                     ▼
    │        ├────────────► 被邀请用户获得1天试用VIP
    │        │
    ▼
创建用户记录
    │
    ▼
显示注册成功
```

### 2. VIP兑换码使用流程
```
用户输入兑换码
    │
    ▼
验证兑换码格式
    │
    ▼
检查兑换码是否存在
    │
    ├─否──► 返回错误：无效兑换码
    │
    ▼
检查是否已过期
    │
    ├─是──► 返回错误：兑换码已过期
    │
    ▼
检查使用次数是否已达上限
    │
    ├─是──► 返回错误：兑换码已用完
    │
    ▼
【原子操作】
├─ 更新兑换码使用次数
├─ 增加用户VIP时长
└─ 增加用户永久次数
    │
    ▼
返回成功信息
```

### 3. 伴侣绑定VIP奖励流程
```
用户A发起绑定
    │
    ▼
用户B确认绑定
    │
    ▼
系统执行绑定
    │
    ├─ 更新用户A：bindPartnerOpenid = B
    ├─ 更新用户B：bindPartnerOpenid = A
    ├─ 用户A获得7天试用VIP
    └─ 用户B获得7天试用VIP
    │
    ▼
绑定成功
```

## 数据库关系图

```
users (用户表)
├── _id (openid)
├── vipExpireTime (VIP过期时间)
├── permanentFilmQuota (永久次数)
├── trialVipStartTime (试用开始时间)
├── bindPartnerOpenid (绑定伴侣ID)
├── inviterOpenid (邀请者ID)
└── ...

vip_codes (兑换码表)
├── _id
├── code (兑换码内容)
├── days (VIP天数)
├── extra_quota (额外次数)
├── usageLimit (使用限制)
├── usedCount (已使用次数)
├── expireTime (过期时间)
└── isActive (是否激活)

app_config (应用配置)
├── _id
├── key (配置键)
├── value (配置值)
│   ├── sudo_users (管理员列表)
│   └── vip_exchange_enabled (兑换开关)
└── ...
```

## 权限验证流程

```
用户请求操作
    │
    ▼
检查是否为sudo用户
    │
    ├─是──► 拥有永久VIP权限
    │        │
    │        ▼
    │     允许操作
    │
    ▼
检查VIP是否过期
    │
    ├─未过期──► isVip = true
    │    │
    │    ▼
    │   允许操作
    │
    ▼
检查是否为注册日
    │
    ├─是──► 额外10次
    │
    ▼
应用基础限制
    │
    ▼
返回权限结果
```

## 测试环境架构

```
测试配置
    │
├── TEST_CONFIG.ENABLE = true/false
├── TEST_CONFIG.WHITELIST = [openid列表]
│
├─ 开发者模式
│   ├─ 跳过AI API调用
│   ├─ 返回测试图片
│   └─ 不消耗次数
│
└─ 生产模式
    ├─ 正常调用AI API
    ├─ 消耗用户次数
    └─ 完整业务流程
```

## 运营管理架构

```
运营管理后台
    │
├── 兑换码管理
│   ├── 生成新兑换码
│   ├── 查看使用情况
│   └── 设置有效期
│
├── 用户管理
│   ├── 查看用户信息
│   ├── 授权VIP权限
│   └── 查看使用记录
│
└── 系统配置
    ├── 调整VIP权益
    ├── 开关兑换功能
    └── 更新测试白名单
```

## 安全机制

```
安全防护
    │
├── 原子操作
│   └── 防止兑换码并发使用
│
├── 权限验证
│   ├── sudo用户验证
│   ├── 操作者身份确认
│   └── 敏感操作日志
│
├── 数据校验
│   ├── 兑换码格式验证
│   ├── 参数合法性检查
│   └── 防SQL注入
│
└── 访问控制
    ├── openid身份标识
    ├── 云函数权限隔离
    └── 敏感数据加密
```