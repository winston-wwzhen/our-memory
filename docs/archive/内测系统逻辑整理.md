# OurMemory 内测系统逻辑整理 (已归档)

> **注意**：本文档已归档，仅作为历史参考。请查看最新的VIP系统部署指南。

## 概述
OurMemory小程序的内测系统主要包括VIP特权管理、邀请机制、兑换码系统等核心功能，旨在为早期用户提供更好的体验并促进用户增长。

## 一、VIP体系架构

### 1.1 VIP类型定义
```javascript
// 位置：cloudfunctions/user_center/services/auth.js:143-147
- isPermanentVip: 永久VIP（管理员/开发者）
- isTrialVip: 试用VIP（有时间限制）
- isVip: 综合VIP状态（以上两种类型的任意一种）
```

### 1.2 VIP权益对比
| 用户类型 | 每日免费次数 | 注册日福利 | 其他权益 |
|---------|------------|----------|---------|
| 普通用户 | 1次 | 无 | - |
| 新用户 | 1次 | 注册日+10次 | - |
| 试用VIP | 7次 | 注册日+10次 | 内测专属标识 |
| 永久VIP | 7次 | 注册日+10次 | 管理员权限 |

### 1.3 VIP获取方式
1. **邀请机制**：新用户通过邀请注册，邀请者和被邀请者各获得7天试用VIP
2. **绑定伴侣**：双方绑定后各获得7天试用VIP
3. **兑换码**：使用内测兑换码获得VIP时长和永久次数
4. **管理员授权**：sudo用户可直接给其他用户授权VIP

## 二、核心业务逻辑

### 2.1 新用户注册流程
```javascript
// 位置：cloudfunctions/user_center/services/auth.js:104-107
if (isInvited && !userInfo.registerTime) {
  // 被邀请的新用户注册即送1天试用VIP
  await db.collection('users').doc(userRecord._id).update({
    vipExpireTime: new Date(Date.now() + 24 * 60 * 60 * 1000),
    trialVipStartTime: new Date(),
  });
}
```

### 2.2 伴侣绑定VIP奖励
```javascript
// 位置：cloudfunctions/user_center/services/auth.js:353-357
// 内测时试用vip天数
const VIP_TRIAL_DAYS = 7;
const vipExpireTime = new Date(Date.now() + VIP_TRIAL_DAYS * 24 * 60 * 60 * 1000);

// 同时给双方更新VIP状态
await db.collection('users').doc(myOpenid).update({
  vipExpireTime,
  bindPartnerOpenid: partnerOpenid,
  trialVipStartTime: new Date(),
});
```

### 2.3 兑换码系统
```javascript
// 位置：cloudfunctions/user_center/services/auth.js:547-678
兑换码功能包含：
- 原子性操作防止并发使用
- 使用次数限制
- 过期时间验证
- VIP时长增加
- 永久次数赠送
```

## 三、配置参数

### 3.1 业务规则配置
```json
// 位置：miniprogram/utils/business_rules.json
{
  "NORMAL_FREE_LIMIT": 1,        // 普通用户每日限制
  "VIP_DAILY_LIMIT": 7,          // VIP用户每日限制
  "REG_DAY_LIMIT": 10,           // 注册日额外次数
  "VIP_TRIAL_DAYS": 3            // 试用VIP天数（注意：实际代码中使用7天）
}
```

### 3.2 兑换码生成配置
```javascript
// 位置：scripts/add_vip_codes.js
{
  days: 10,           // VIP时长
  extra_quota: 5,     // 永久额外次数
  usageLimit: 100,    // 使用次数限制
  prefix: "LOVE-"     // 兑换码前缀
}
```

## 四、数据库设计

### 4.1 核心集合结构
```javascript
// 位置：cloudfunctions/init_db/index.js
1. users - 用户信息
   - vipExpireTime: VIP过期时间
   - permanentFilmQuota: 永久次数
   - trialVipStartTime: 试用VIP开始时间
   - bindPartnerOpenid: 绑定伴侣ID
   - inviterOpenid: 邀请者ID

2. vip_codes - 兑换码
   - code: 兑换码内容
   - days: VIP天数
   - extra_quota: 额外永久次数
   - usageLimit: 使用次数限制
   - usedCount: 已使用次数
   - expireTime: 过期时间
   - isActive: 是否激活

3. app_config - 应用配置
   - sudo_users: 管理员列表
   - vip_exchange_enabled: VIP兑换功能开关
```

## 五、测试环境配置

### 5.1 测试白名单
```javascript
// 位置：cloudfunctions/process_anime/index.js:12-16
const TEST_CONFIG = {
  WHITELIST: [],  // 测试用户openid列表
  ENABLE: true,   // 测试模式开关
};
```

### 5.2 管理员权限
```javascript
// 位置：cloudfunctions/user_center/utils/config.js:22-29
// sudo用户拥有：
- 永久VIP权限
- 给其他用户授权VIP的权限
- 管理兑换码的权限
```

## 六、前端展示逻辑

### 6.1 我的页面VIP展示
```javascript
// 位置：miniprogram/pages/mine/index.wxml:10-19
- VIP徽章显示
- "内测 VIP" 标识
- 兑换VIP按钮（受云配置控制）
- VIP权益弹窗
```

### 6.2 首页特权提示
```javascript
// 位置：miniprogram/pages/index/index.js:268-270
- 内测VIP权益说明
- 新用户福利提示
- 每日免费次数说明
```

## 七、关键业务流程

### 7.1 次数消费逻辑
```javascript
1. 检查是否VIP（永久或试用）
2. 检查是否为注册日
3. 计算当日剩余次数
4. 扣除相应类型的次数（优先扣除临时次数）
```

### 7.2 VIP状态检查
```javascript
1. 检查是否在sudo用户列表
2. 检查vipExpireTime是否未过期
3. 综合判断用户VIP状态
```

## 八、运营工具

### 8.1 兑换码生成脚本
```bash
# 运行脚本
node scripts/add_vip_codes.js

# 支持参数
--code  指定兑换码
--days  设置VIP天数
--quota 设置额外次数
--limit 设置使用限制
```

### 8.2 用户管理
- 管理员可通过云函数给用户授权VIP
- 支持查看用户VIP状态和使用情况
- 可动态调整内测参数

## 九、注意事项

1. **数据一致性**：兑换码使用采用原子操作，防止并发问题
2. **时间处理**：所有时间计算基于服务器时间，避免客户端时区问题
3. **权限控制**：管理员操作需要验证sudo身份
4. **配置灵活性**：关键参数支持云端配置，便于运营调整
5. **测试隔离**：测试白名单机制确保不影响生产环境

## 十、优化建议

1. 统一VIP试用天数的配置（目前代码中存在3天和7天不一致）
2. 增加更详细的操作日志记录
3. 添加兑换码使用记录追踪
4. 完善错误处理和用户提示
5. 考虑添加VIP等级体系，为后续功能扩展做准备