# 🚀 我们的纪念册 (Our Memory) v1.3.0 上线部署手册 (Final Edition)

**版本目标**: 上线萌宠/情头模块，确立“赤字经济”模型，开启流量主变现
**上线时间**: 预计明日
**当前状态**: 代码冻结 (Code Freeze) -> 准备部署

---

## 📅 第一阶段：代码与静态资源确认 (Code & Assets)
> **执行时间**: 上线前 4 小时
> **目标**: 确保所有“数值”和“文案”已修改为最新商定版本

### 1.1 🌍 景点与旅行数值确认 (Critical)
* **文件路径**: `cloudfunctions/init_destinations/index.js`
* **检查点**:
    - [ ] 确认已更新为 **10个景点** 配置（含新增的5个高级景点）。
    - [ ] **Lv1-3 景点**: 玫瑰概率需在 **40% - 60%** (新手福利，高频产出)。
    - [ ] **Lv7-10 景点**: 玫瑰概率需为 **100%** (高级必出，数量递增)。
    - [ ] **孤独灯塔 (Lv5)**: 消耗需改为 `deluxe_meal` x 2，奖励爱意值改为 `100g` (制造爱意赤字)。

### 1.2 🍱 物价与邀请奖励确认
* **文件路径**: `cloudfunctions/user_center/config/food_price.json` (或对应常量)
    - [ ] **豪华御膳**: 价格需调整为 **100g**。
    - [ ] **普通饭团**: 价格需调整为 **20g**。
* **文件路径**: `cloudfunctions/user_center/services/auth.js`
    - [ ] **邀请奖励**: 需调整为 **200g爱意 + 1张胶卷 + 1朵玫瑰** (控制成本，防刷单)。

### 1.3 🎟️ 卡券定价与文案优化 (Updated!)
* **文件路径**: `miniprogram/utils/coupon_templates.js`
    - [ ] **N级卡券 (揉肩/奶茶)**: 价格需降至 **2-3 玫瑰** (降低门槛)。
    - [ ] **SSR级卡券**: 保持 50+ 玫瑰。
* **文件路径**: `miniprogram/pages/coupon/detail.wxml` (UI优化)
    - [ ] **新增免责声明**: 在详情页底部或核销弹窗中，添加如下文案（带幽默风样式）：
      > **“最终解释权归持券人所有。如对方拒不履行，请痛扁对方一顿。”**

### 1.4 🎁 首页 UI 邀请入口优化
* **文件路径**: `miniprogram/pages/mine/index.wxml`
    - [ ] **文案修改**: 分享按钮 Tag 改为 `🎁 领福利`。
    - [ ] **描述修改**: 改为 `得1朵玫瑰 + 永久AI胶卷 + 200g爱意`。

---

## 🛠️ 第二阶段：PROD 环境初始化 (Environment Setup)
> **执行时间**: 上线前 2 小时
> **目标**: 确保生产环境数据库结构完整，新配置生效

### 2.1 ☁️ 云环境配置
1.  确认 `miniprogram/envList.js` 已指向 PROD 环境 ID。
2.  开发者工具切换至 **PROD** 环境。

### 2.2 💾 部署云函数 (全量更新)
* **操作**: 右键 `cloudfunctions` -> 选择 PROD 环境 -> **上传并部署：云端安装依赖**。
* **重点关注函数** (因逻辑有修改):
    * `user_center` (含 pet/auth 逻辑修改，特别是**双人共享奖励**机制)
    * `init_destinations` (新景点配置)
    * `process_anime` (确保超时时间已设为 60s)
    * `get_daily_mission`

### 2.3 🧱 数据库初始化 & 数据刷新
* **重要**: 由于修改了景点配置，需要重新运行初始化函数覆盖旧数据。
1.  **更新景点**: 调用 `init_destinations` 云函数。
2.  **更新头像**: 调用 `init_avatar_data` (补全圣诞特辑)。
3.  **检查配置**: 查看 DB `app_config` 表，确认 `global_settings` 存在。

---

## 🛡️ 第三阶段：提审与过审开关 (Audit Prep)
> **执行时间**: 提交审核前 30 分钟
> **目标**: 隐藏敏感入口，防止拒审。

### 3.1 🔒 关闭敏感开关
* **操作**: 云开发控制台 (PROD) -> 数据库 -> `app_config` -> `global_settings`。
* **设置**:
    * `SHOW_VIP_EXCHANGE`: `false` (隐藏VIP兑换)
    * `SHOW_INVITE_REWARD`: `false` (建议审核期间隐藏具体的“利益”描述，或确保文案不含“提现/返利”字眼)

### 3.2 📤 上传提审
* 版本号: `1.3.0`
* 备注: “优化用户体验，修复已知 Bug”。

---

## 📈 第四阶段：运营监控 (Post-Launch)
> **执行时间**: 审核通过并发布后

### 4.1 🔓 开启功能开关
1.  将 `app_config` 中的 `SHOW_VIP_EXCHANGE` 改回 `true`。
2.  将邀请奖励相关开关开启（如适用）。

### 4.2 🎫 生成 VIP 营销码
* **脚本**: `scripts/add_vip_codes.js` (确认配置为 5张胶卷 + 520爱意 + 3玫瑰)。
* **执行**: 生成一批口令，用于冷启动推广。

---

## ✅ 上线前最终核对清单 (Final Checklist)

- [ ] **经济模型已确认**: 豪华御膳=100g, 邀请奖励=200g+1胶卷+1玫瑰
- [ ] **景点配置已确认**: Lv10 景点玫瑰爆率 100%，Lv1-3 易出货
- [ ] **卡券免责文案已添加**: "拒不履行请痛扁对方"
- [ ] `envList.js` 已切换至 PROD
- [ ] 所有云函数已重新部署
- [ ] 提审开关已关闭 (`SHOW_VIP_EXCHANGE`: false)
