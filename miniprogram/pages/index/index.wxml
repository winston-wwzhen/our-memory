<view class="journal-container">
  
  <view class="bg-decoration">
    <view class="floating-heart h1">â¤</view>
    <view class="floating-heart h2">âœ¨</view>
    <view class="floating-heart h3">â¤</view>
    <view class="floating-heart h4">âœ¨</view>
    <view class="floating-heart h5">â¤</view>
  </view>

  <view class="content-wrapper">
    
    <view class="task-note-container slide-in-down" wx:if="{{currentTask}}">
      <view class="task-note">
        <view class="pin-icon">ğŸ“Œ</view>
        <view class="note-header">
          <text class="note-icon">{{currentTask.icon}}</text>
          <view class="header-text">
            <text class="note-label">ä»Šæ—¥é™å®š</text>
            <text class="note-title">{{currentTask.title}}</text>
          </view>
        </view>
        <text class="note-desc">{{currentTask.description}}</text>
        
        <view class="remote-tip-box">
          <text>ğŸ’¡ å¼‚åœ°è´´å£«ï¼šè§†é¢‘é€šè¯æˆªå›¾ä¹Ÿèƒ½ç”œèœœæš´å‡»å“¦ï¼</text>
        </view>

        <view class="note-footer">
          <text class="difficulty-tag">ç”œèœœåº¦ Lv.{{currentTask.difficulty}}</text>
          <text class="date-tag">{{todayDateStr}}</text>
        </view>
      </view>
    </view>

    <view class="polaroid-frame {{loading ? 'developing-pulse' : 'floating-updown'}}" 
          bindtap="{{loading ? '' : (!pendingSave ? '' : 'previewImage')}}">
          <view class="photo-area">
        <block wx:if="{{displayImage}}">
          <image src="{{displayImage}}" mode="aspectFill" class="the-photo"></image>
          <view class="score-stamp stamp-anim" wx:if="{{pendingSave && aiEvaluation}}">
            <view class="stamp-circle">
              <text class="stamp-label">AI é‰´å®š</text>
              <text class="stamp-score">{{aiEvaluation.score}}</text>
            </view>
          </view>
        </block>

        <view class="empty-state-cover" wx:else>
          <swiper 
            class="style-swiper" 
            circular 
            previous-margin="60rpx" 
            next-margin="60rpx" 
            bindchange="onStyleChange" 
            current="{{currentStyleIndex}}"
          >
            <block wx:for="{{styleList}}" wx:key="id">
              <swiper-item class="style-swiper-item">
                <view class="swiper-card {{currentStyleIndex === index ? 'active' : ''}}">
                  <image src="{{item.img}}" mode="aspectFill" class="sample-img"></image>
                  
                  <view class="inner-style-tag">
                    <text>{{item.name}}</text>
                    <text wx:if="{{item.isVip}}" class="vip-badge">VIP</text>
                  </view>
                  
                  <view class="card-mask" wx:if="{{currentStyleIndex !== index}}"></view>
                </view>
              </swiper-item>
            </block>
          </swiper>

          <view class="swipe-hint-text">
            <text>â† å·¦å³æ»‘åŠ¨åˆ‡æ¢é£æ ¼ â†’</text>
          </view>

          <view class="empty-overlay">
            <view class="camera-btn-circle {{isVip ? 'vip-btn' : ''}}" bindtap="onCapture">
              
              <view class="btn-ripple" wx:if="{{!isVip}}"></view>
              
              <view class="vip-ripple" wx:if="{{isVip}}"></view>
              
              <image src="../../images/camera-icon.png" class="camera-icon-img"></image>
              
              <view class="vip-crown" wx:if="{{isVip}}">ğŸ‘‘</view>
            </view>

            <text class="empty-hint" wx:if="{{isVip}}">è®°å½•çˆ±æ„æ—¶åˆ» âœ¨</text>
            <text class="empty-hint" wx:else>ç‚¹è¿™é‡Œï¼Œå®šæ ¼æ­¤åˆ» âœ¨</text>
            
            <text class="quota-hint {{isVip ? 'vip-quota' : ''}}">å‰©ä½™èƒ¶å·ï¼š{{remainingCount}} å¼ </text>
          </view>
        </view>

        <view class="loading-mask" wx:if="{{loading}}">
          <view class="loading-spinner"></view>
          <text class="loading-text">{{loadingText}}</text>
        </view>
      </view>
      
      <view class="handwriting-caption">
        <block wx:if="{{loading}}">æ­£åœ¨æ–½å±•é­”æ³•...</block>
        <block wx:elif="{{pendingSave && aiEvaluation}}">â€œ {{aiEvaluation.comment}} â€</block>
        <block wx:elif="{{pendingSave}}">âœ¨ Our Magic Moment âœ¨</block>
        <block wx:else>æ»‘åŠ¨åˆ‡æ¢æ›´å¤šæœ‰è¶£çš„é£æ ¼ â¡ï¸</block>
      </view>
    </view>

    <view class="daily-quote-box fade-in" wx:if="{{!pendingSave}}">
      <text class="quote-text">â€œ{{dailyQuote.text}}â€</text>
      <text class="quote-author">â€” {{dailyQuote.author}} â€”</text>
    </view>

    <view class="action-bar slide-in-up" wx:if="{{pendingSave}}">
      <view class="replace-tip" wx:if="{{hasCheckedInToday && !isSaved}}">
        âœ¨ ä»Šæ—¥å·²æ‰“å¡ï¼Œè¿™å¼ å°†ä½œä¸ºæ–°å›å¿†ä¿å­˜
      </view>

      <view class="confirm-actions">
  
        <view class="action-btn-wrapper" catchtap="onSaveToPhone">
          <view class="btn-circle sub"><text>â¬‡ï¸</text></view>
          <text class="btn-label">ç§è—</text>
        </view>

        <view class="action-btn-wrapper" catchtap="onRetry">
          <view class="btn-circle sub"><text>ğŸ”„</text></view>
          <text class="btn-label">{{isSaved ? 'å†æ‹ä¸€å¼ ' : 'å†æ¥ä¸€å¼ '}} ({{remainingCount}})</text>
        </view>

        <button 
          class="btn-confirm-main {{isSaved ? 'saved-state' : ''}}" 
          catchtap="{{isSaved ? '' : 'onConfirmSave'}}"
        >
          {{isSaved ? 'å·²çè— âœ¨' : 'å­˜å…¥çºªå¿µå†Œ â¤ï¸'}}
        </button>
      </view>
    </view>

    <view class="placeholder-box" wx:if="{{!pendingSave}}"></view>

  </view>

  <view class="ad-modal-mask" wx:if="{{showAdModal}}" catchtouchmove="true">
    <view class="ad-modal-content">
      <text class="ad-modal-emoji">âœ¨</text>
      <text class="ad-modal-text">é—­ä¸Šçœ¼ï¼Œåœ¨å¿ƒé‡Œé»˜å¿µ TA çš„åå­—...</text>
      <text class="ad-countdown">{{adCountdown}}</text>
    </view>
  </view>

  <view class="egg-modal-mask" wx:if="{{showEggModal}}" catchtouchmove="true">
  <view class="god-rays"></view>
  <view class="confetti-container">
    <view class="confetti c1"></view><view class="confetti c2"></view><view class="confetti c3"></view>
    <view class="confetti c4"></view><view class="confetti c5"></view><view class="confetti c6"></view>
    <view class="confetti c7"></view><view class="confetti c8"></view><view class="confetti c9"></view>
    <view class="confetti c10"></view>
  </view>
  <view class="egg-card bounce-in">
    <view class="card-ribbon">LUCKY TIME</view>
    <view class="icon-stage">
      <view class="halo-ring"></view>
      <text class="egg-icon">{{eggData.icon}}</text>
      <view class="shine-star s-left">âœ¨</view>
      <view class="shine-star s-right">âœ¨</view>
    </view>
    <view class="egg-title">{{eggData.title}}</view>
    <view class="egg-desc">{{eggData.desc}}</view>
    <view class="egg-reward-box">
      <text class="reward-label">è·å¾—å¥–åŠ±</text>
      <view class="reward-val-row">
        <text class="val-num">+{{eggData.bonus}}</text>
        <text class="val-unit">g çˆ±æ„ ğŸ’§</text>
      </view>
    </view>
    <button class="btn-get-egg" bindtap="closeEggModal">
      <text>å¼€å¿ƒæ”¶ä¸‹ â¤ï¸</text>
    </button>
  </view>
</view>

  <!-- äººè„¸ç¡®è®¤æ¨¡æ€æ¡† -->
  <view class="face-confirm-modal-mask" wx:if="{{showFaceConfirmModal}}" catchtouchmove="true">
    <view class="face-confirm-modal bounce-in">
      <view class="modal-header">
        <text class="modal-title">ğŸ“¸ ç…§ç‰‡ç¡®è®¤</text>
        <text class="modal-subtitle">è¯·ç¡®ä¿ç…§ç‰‡è´¨é‡ä»¥è·å¾—æœ€ä½³AIæ•ˆæœ</text>
      </view>

      <view class="image-preview-wrapper">
        <image src="{{selectedImagePath}}" mode="aspectFit" class="preview-photo"></image>

        <!-- äººè„¸å¼•å¯¼æ¡† -->
        <view class="face-guide-overlay">
          <view class="guide-frame pulse">
            <view class="corner top-left"></view>
            <view class="corner top-right"></view>
            <view class="corner bottom-left"></view>
            <view class="corner bottom-right"></view>
            <text class="frame-label">äººè„¸åŒºåŸŸ</text>
          </view>
        </view>
      </view>

      <view class="guide-tips">
        <view class="tip-check">
          <text class="check-icon">âœ“</text>
          <text>äººè„¸æ¸…æ™°ï¼Œè¡¨æƒ…è‡ªç„¶</text>
        </view>
        <view class="tip-check">
          <text class="check-icon">âœ“</text>
          <text>é¿å…è¿œæ™¯ã€æ¨¡ç³Šç…§ç‰‡</text>
        </view>
        <view class="tip-check">
          <text class="check-icon">âœ“</text>
          <text>å…‰çº¿å……è¶³ï¼ŒèƒŒæ™¯ç®€æ´</text>
        </view>
      </view>

      <view class="modal-buttons">
        <button class="btn-reselect" bindtap="onReselectImage">é‡æ–°é€‰æ‹©</button>
        <button class="btn-use-photo" bindtap="onConfirmImage">ä½¿ç”¨è¿™å¼ ç…§ç‰‡</button>
      </view>
    </view>
  </view>
</view>