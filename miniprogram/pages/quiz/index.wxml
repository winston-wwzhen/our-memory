<view class="quiz-container">

<block wx:if="{{mode === 'home'}}">
  <view class="header-banner">
    <view class="banner-title">é»˜å¥‘å¤§é—¯å…³</view>
    <view class="banner-sub">Test Your Love</view>
  </view>

  <view class="current-card paper-texture">
    <block wx:if="{{currentRoundInfo}}">
      <view class="round-badge-row">
        <text class="round-badge-icon">ğŸ”¥</text>
        <text class="round-badge-txt">ç¬¬ {{currentRoundInfo.round_seq}} è½®æ­£åœ¨è¿›è¡Œ</text>
      </view>
      <view class="progress-bar-box">
        <view class="p-label">ç­”é¢˜è¿›åº¦</view>
        <view class="p-avatars">
           <view class="p-user mine">æˆ‘ {{currentRoundInfo.my_progress}}/10</view>
           <view class="p-vs">VS</view>
           <view class="p-user partner">TA {{currentRoundInfo.partner_progress}}/10</view>
        </view>
      </view>
      <button class="btn-start" bindtap="onStart">
        {{currentRoundInfo.status === 'waiting_partner' ? 'æŸ¥çœ‹çŠ¶æ€' : 'ç»§ç»­ç­”é¢˜'}}
      </button>
    </block>
    <block wx:else>
      <view class="empty-round-box">
         <text class="empty-emoji">ğŸš€</text>
         <text class="empty-title">å‡†å¤‡å¥½å¼€å§‹æ–°ä¸€è½®æŒ‘æˆ˜äº†å—ï¼Ÿ</text>
         <button class="btn-start" bindtap="onStart">å¼€å¯æ–°ä¸€è½®</button>
      </view>
    </block>
  </view>

  <view class="history-section">
      <view class="section-header">
          <text class="sec-title">ğŸ“œ é€šå…³è®°å½•</text>
      </view>
      
      <view class="history-list">
          <view class="history-item" wx:for="{{history}}" wx:key="_id" bindtap="onHistoryTap" data-id="{{item._id}}">
              <view class="h-left">
                  <view class="h-round">ç¬¬ <text class="h-num">{{item.round_seq}}</text> è½®</view>
                  <view class="h-time">{{item.dateStr}}</view>
              </view>
              
              <view class="h-right">
                  <view class="h-score-box {{item.score >= 80 ? 'high' : ''}}">
                      <text class="val">{{item.score}}</text>
                      <text class="unit">åˆ†</text>
                  </view>
                  <view class="arrow">></view>
              </view>
          </view>
          
          <view class="no-history" wx:if="{{history.length===0}}">
              <text>æš‚æ— å†å²è®°å½•ï¼Œå¿«å»é—¯å…³å§ï¼</text>
          </view>
      </view>
  </view>
</block>

<block wx:if="{{mode === 'answering'}}">
  <view class="question-card">
    <view class="q-step">Question {{qIndex}} / {{total}}</view>
    <view class="q-title">{{currentQuestion.title}}</view>
  </view>

  <view class="options-list">
    <view 
      class="option-btn" 
      wx:for="{{displayOptions}}" 
      wx:key="index"
      bindtap="onOptionClick"
      data-index="{{index}}"
    >
      <text class="opt-text">{{item}}</text>
    </view>
  </view>
</block>

<block wx:if="{{mode === 'waiting'}}">
  <view class="waiting-box">
    <view class="wait-icon">â³</view>
    <view class="wait-text">æœ¬è½®ä½œç­”å®Œæˆ</view>
    <view class="wait-sub">ç­‰å¾… TA å®Œæˆåè‡ªåŠ¨æ­æ™“åˆ†æ•°...</view>
    <button class="btn-refresh" bindtap="onManualRefresh">â†» åˆ·æ–°çŠ¶æ€</button>
    <button class="btn-back" bindtap="loadHome">è¿”å›åˆ—è¡¨</button>
  </view>
</block>

<block wx:if="{{mode === 'result'}}">
  <view class="result-header">
    <view class="score-circle">
      <text class="score-val">{{roundResult.score}}</text>
      <text class="score-label">é»˜å¥‘åˆ†</text>
    </view>
    <view class="result-comment" wx:if="{{roundResult.score === 100}}">ğŸ’¯ çµé­‚ä¼´ä¾£ï¼</view>
    <view class="result-comment" wx:elif="{{roundResult.score >= 60}}">ğŸ‰ ç»§ç»­åŠ æ²¹ï¼</view>
    <view class="result-comment" wx:else>ğŸ’” éœ€è¦æ²Ÿé€šå“¦~</view>
  </view>

  <view class="review-list">
    <block wx:for="{{roundResult.questions}}" wx:key="title">
      <view class="review-item">
        <view class="r-q">{{index+1}}. {{item.title}}</view>
        <view class="r-ans-row">
          <view class="r-col">
            <text class="label">æˆ‘é€‰</text>
            <text class="r-val {{roundResult.answers_a[index] == roundResult.answers_b[index] ? 'match' : ''}}">
              {{item.options[isUserA ? roundResult.answers_a[index] : roundResult.answers_b[index]]}}
            </text>
          </view>
          <view class="vs-icon {{roundResult.answers_a[index] == roundResult.answers_b[index] ? 'match' : ''}}">
               {{roundResult.answers_a[index] == roundResult.answers_b[index] ? 'â™¥' : 'Ã—'}}
          </view>
          <view class="r-col right">
            <text class="label">TAé€‰</text>
            <text class="r-val {{roundResult.answers_a[index] == roundResult.answers_b[index] ? 'match' : ''}}">
              {{item.options[isUserA ? roundResult.answers_b[index] : roundResult.answers_a[index]]}}
            </text>
          </view>
        </view>
      </view>
    </block>
  </view>

  <button class="btn-next-round" bindtap="loadHome">è¿”å›åˆ—è¡¨</button>
</block>

<view class="egg-modal-mask" wx:if="{{showEggModal}}">
  <view class="egg-card bounce-in">
    <text class="egg-icon">{{eggData.icon}}</text>
    <view class="egg-title">{{eggData.title}}</view>
    <view class="egg-desc">{{eggData.desc}}</view>
    <button class="btn-get-egg" bindtap="closeEggModal">å¤ªæ£’äº†</button>
  </view>
</view>

</view>