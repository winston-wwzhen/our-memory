# 🚀 我们的纪念册 (Our Memory) v1.3.0 上线部署手册

**版本目标**: 上线萌宠/情头模块，开启运营推广
**上线时间**: 预计明日
**当前状态**: 代码冻结前夕 (Code Freeze Pending)

---

## 📅 第一阶段：内容与数据准备 (Content Prep)
> **执行时间**: 上线前 4 小时
> **目标**: 确保所有静态资源就位，文案无误

### 1.1 🌍 补全旅行目的地数据 (10个)
* **文件路径**: `cloudfunctions/init_destinations/index.js`
* **操作**: 在 `DEFAULT_DESTINATIONS` 数组中追加 10 个新地点对象。
* **注意**: 
    * 确保 `image` 和 `postcard_image` 的图片已上传至云存储 (`cloud://...` 或 `https://...`)。
    * `id` 必须唯一，建议命名规范如 `sight6_snow_mountain`。

### 1.2 👩‍❤️‍👨 补全情侣头像数据 (30组)
* **文件路径**: `cloudfunctions/init_avatar_data/index.js`
* **操作**: 在 `INITIAL_DATA` 数组中追加 30 组新数据。
* **运营建议**: 
    * 将 5-10 组圣诞/元旦主题头像的 `sort_order` 设为 `200` (置顶)。
    * 设置 `downloads` 初始值为 `500-2000` 之间的随机数，营造热度。

### 1.3 ✍️ 文案优化 (Copywriting)
* **检查点**:
    * `miniprogram/pages/index/index.wxml`: 首页 Slogan 是否有吸引力？
    * `miniprogram/pages/pet/index.wxml`: 宠物引导文案是否温馨？
    * `cloudfunctions/init_task_pool/index.js`: 每日任务文案是否有错别字？

---

## 🛠️ 第二阶段：PROD 环境初始化 (Environment Setup)
> **执行时间**: 上线前 2 小时
> **目标**: 确保生产环境数据库结构完整，基础数据已加载

### 2.1 ☁️ 云环境配置
1.  打开微信开发者工具 -> 云开发 -> 设置 -> 环境设置。
2.  确认已创建 **PROD (生产环境)**，并复制环境 ID。
3.  修改前端配置 `miniprogram/envList.js`:
    ```javascript
    const envList = [{"envId":"你的PROD环境ID","alias":"prod"}]
    ```

### 2.2 💾 部署云函数 (至 PROD 环境)
* **动作**: 在开发者工具中，右键 `cloudfunctions` 文件夹 -> 选择环境 -> **PROD**。
* **批量部署**: 依次右键以下文件夹 -> **上传并部署：云端安装依赖**：
    1.  `init_db`
    2.  `init_app_config`
    3.  `init_avatar_data`
    4.  `init_destinations`
    5.  `init_task_pool`
    6.  `user_center` (核心业务)
    7.  `get_daily_mission`
    8.  `process_anime`
    9.  ...其他所有云函数

### 2.3 🧱 数据库初始化 & 数据灌入
> **关键步骤**: 必须按顺序执行，确保数据进入 PROD 库。

1.  **建表**: 在开发者工具控制台或新建临时的测试 Page，调用一次 `init_db`：
    ```javascript
    wx.cloud.callFunction({ name: 'init_db' })
    ```
    *检查*: 云开发控制台 -> 数据库，确认 `users`, `pets`, `app_config` 等集合已自动创建。

2.  **灌入数据**: 依次调用初始化函数：
    ```javascript
    await wx.cloud.callFunction({ name: 'init_app_config' }) // 初始化开关配置
    await wx.cloud.callFunction({ name: 'init_avatar_data' }) // 灌入80组头像
    await wx.cloud.callFunction({ name: 'init_destinations' }) // 灌入15个景点
    await wx.cloud.callFunction({ name: 'init_task_pool' }) // 灌入任务池
    ```

---

## 🛡️ 第三阶段：提审与过审开关 (Audit Prep)
> **执行时间**: 提交审核前 30 分钟
> **目标**: **隐藏 VIP 兑换入口**，防止因“iOS 虚拟支付”或“诱导分享”被拒审。

### 3.1 🔒 关闭 VIP 入口 (Feature Toggle)
* **原理**: 小程序端通过读取 `app_config` 集合中的配置来控制显隐。
* **操作**: 
    1.  打开云开发控制台 (PROD环境) -> 数据库 -> `app_config` 集合。
    2.  找到 (或新建) 记录 `_id: "config"` (或根据你的 `init_app_config` 逻辑)。
    3.  **修改字段**: 设置 `SHOW_VIP_EXCHANGE` 为 `false`。
    *代码参考 (`cloudfunctions/user_center/index.js`)*:
    ```javascript
    case "get_system_config":
      return {
        success: true,
        data: {
          showVipExchange: ctx.CONFIG.SHOW_VIP_EXCHANGE, // 确保这里读取的是 false
        },
      };
    ```

### 3.2 📱 真机验证
* 在开发者工具中，将模式切为“真机调试”。
* 进入“我的”或“商店”页面，**确认看不到“兑换码/VIP”入口**。
* 确认其他核心功能（宠物喂食、AI生图）正常。

### 3.3 📤 上传提审
* 点击开发者工具右上角“上传”。
* 版本号: `1.3.0`。
* 备注: “修复已知问题，优化用户体验” (不要写“新增VIP功能”等敏感词)。

---

## 📈 第四阶段：运营监控与脚本准备 (Operations)
> **执行时间**: 审核通过并发布后
> **目标**: 开启功能，监控数据

### 4.1 🔓 开启 VIP 入口 (发布后)
1.  审核通过并点击“全量发布”后。
2.  立即去云数据库 `app_config` 集合，将 `SHOW_VIP_EXCHANGE` 改回 `true`。
3.  重启小程序，确认入口出现。

### 4.2 🎫 生成运营兑换码
* **场景**: 为小红书/咸鱼推广准备。
* **脚本路径**: `scripts/add_vip_codes.js` (需确认已创建此脚本)
* **操作**:
    ```bash
    cd scripts
    # 编辑 add_vip_codes.js，修改 code 为 "XMAS2025", days: 30, limit: 100
    node add_vip_codes.js
    ```

### 4.3 📊 数据监控脚本
* **已有脚本**: `scripts/daily_stats.js`
* **功能**: 统计今日新增用户、活跃用户、AI生成次数等。
* **准备工作**:
    1.  确保本地安装了 Node.js。
    2.  安装依赖: `npm install wx-server-sdk` (如果脚本依赖它，或者使用 HTTP API)。
    3.  **重要**: 检查脚本中的 `env` 配置是否指向 PROD 环境 ID。
* **运行**: 每天晚上运行一次 `node scripts/daily_stats.js` 查看日报。

### 4.4 🚨 应急预案
* **AI 接口报错**: 检查腾讯云 AI 资源包是否欠费。
* **图片加载慢**: 检查云存储 CDN 流量包余量。
* **用户反馈 Bug**: 引导用户加客服微信（在“我的”页面预留“联系作者”）。

---

## ✅ 上线前最终核对清单 (Checklist)

- [ ] 15个旅行地点数据已确认 (文案+图片)
- [ ] 80组情侣头像数据已确认 (含圣诞特辑)
- [ ] `envList.js` 已切换至 PROD 环境
- [ ] 云函数已全部上传至 PROD 环境
- [ ] `init_db` 及数据灌入脚本已在 PROD 执行
- [ ] **DB中 `app_config` 的 `SHOW_VIP_EXCHANGE` 已设为 `false`** (提审关键!)
- [ ] 运营脚本 (`add_vip_codes.js`) 已准备好，随时可生成口令
- [ ] 手机真机预览测试通过
